# Database Migrations

This directory contains database migration scripts managed by Alembic.

## Overview

The migrations system allows for:
- Tracking database schema changes
- Automatically generating migration scripts from model changes
- Upgrading or downgrading the database schema
- Creating reproducible database setups

## Migration Files

- `env.py`: Configuration for Alembic
- `script.py.mako`: Template for migration scripts
- `versions/`: Directory containing all migration scripts

## Usage

### Running Migrations

Use the `run_migrations.py` script to manage migrations:

```bash
# Show help
python run_migrations.py --help

# Upgrade database to latest version
python run_migrations.py upgrade

# Downgrade database by one version
python run_migrations.py downgrade

# Create a new migration
python run_migrations.py create "Add new column to devices table"

# Show migration history
python run_migrations.py history

# Show current database revision
python run_migrations.py current

# Initialize migrations for an existing database
python run_migrations.py init
```

### Environment Variables

The migration system can use the following environment variables:

- `DB_HOST`: Database host
- `DB_PORT`: Database port (default: 5432)
- `DB_NAME`: Database name
- `DB_USER`: Database user (default: postgres)
- `DB_PASSWORD`: Database password (default: postgres)

If these variables are not set, the system will use the connection string from `alembic.ini`.

## Best Practices

1. **Review Autogenerated Migrations**: Always review autogenerated migration scripts before applying them
2. **Test Migrations**: Test migrations in a development environment before applying to production
3. **Version Control**: Always keep migration scripts in version control
4. **One Change Per Migration**: Each migration should make a single logical change
5. **Include Downgrade Logic**: Always implement downgrade logic for rollbacks

## Common Issues

### Migration Dependencies

If a migration depends on a previous migration, ensure that the previous migration has been applied.

### Schema Conflicts

If a migration conflicts with manual schema changes, you may need to resolve conflicts manually.

### Data Migration

For data migrations, consider using separate scripts or adding data migration logic to your migration scripts.

## References

- [Alembic Documentation](https://alembic.sqlalchemy.org/en/latest/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/en/14/)
